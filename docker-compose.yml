version: '3.8'

services:

  # 1. ë²¡í„° ë°ì´í„°ë² ì´ìŠ¤ ì„œë¹„ìŠ¤ (ChromaDB)
  chromadb:
    image: chromadb/chroma:latest
    container_name: chroma-server
    ports:
      - "8001:8000" # ChromaDBì˜ ê¸°ë³¸ í¬íŠ¸ëŠ” 8000ì´ì§€ë§Œ, Docker Compose ì™¸ë¶€ì—ì„œ 8001ë¡œ ì ‘ê·¼í•˜ë„ë¡ ì„¤ì •
    volumes:
      - chroma_data:/app/chroma/chroma
    environment:
      # ë¡œì»¬ ê°œë°œ í™˜ê²½ìš© ì„¤ì • (í”„ë¡œë•ì…˜ì—ì„œëŠ” ë” ê²¬ê³ í•œ ì„¤ì • í•„ìš”)
      - IS_PERSISTENT=TRUE 
      - ALLOW_RESET=TRUE
    
    # ğŸ’¡ [í•µì‹¬ ì¶”ê°€]: ChromaDB í—¬ìŠ¤ ì²´í¬ ë¡œì§ ì¶”ê°€
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8000/api/v1/heartbeat || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s # ChromaDBê°€ ì´ˆê¸°í™”ë  ì‹œê°„ì„ ì¤Œ

  # 2. RAG ë°±ì—”ë“œ API ì„œë¹„ìŠ¤ (FastAPI)
  fastapi-api:
    build: 
      context: .
      dockerfile: Dockerfile
    container_name: fastapi-rag-api
    ports:
      - "8000:8000"
    environment:
      # API í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
      - UPSTAGE_API_KEY=${UPSTAGE_API_KEY}
      # ChromaDB ì—°ê²° ì£¼ì†Œ (Docker ë„¤íŠ¸ì›Œí¬ ì´ë¦„)
      - CHROMA_HOST=chromadb 
      - CHROMA_PORT=8000
    depends_on:
      # FastAPIëŠ” ChromaDBê°€ ì¤€ë¹„ëœ í›„ì— ì‹œì‘
      chromadb:
        condition: service_healthy # í—¬ìŠ¤ ì²´í¬ê°€ ì„±ê³µí•´ì•¼ë§Œ ì‹œì‘
    
    # ğŸ’¡ [í•µì‹¬ ìˆ˜ì •]: start_api.pyë¥¼ ì‹¤í–‰í•˜ë„ë¡ ëª…ë ¹ì–´ ë³€ê²½
    command: python start_api.py 

    # ğŸ’¡ [í•µì‹¬ ì¶”ê°€]: FastAPI í—¬ìŠ¤ ì²´í¬ ë¡œì§ ì¶”ê°€
    healthcheck:
      # FastAPIì˜ /health ì—”ë“œí¬ì¸íŠ¸ê°€ 'ready' ìƒíƒœë¥¼ ë°˜í™˜í•˜ëŠ”ì§€ í™•ì¸
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s
      
  # 3. Streamlit í”„ë¡ íŠ¸ì—”ë“œ UI ì„œë¹„ìŠ¤
  streamlit-ui:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: streamlit-rag-ui
    ports:
      - "8501:8501" # Streamlit ê¸°ë³¸ í¬íŠ¸
    environment:
      # Streamlitì—ì„œ FastAPIë¡œ ì ‘ì†í•  ì£¼ì†Œ ì„¤ì • (Docker ë„¤íŠ¸ì›Œí¬ ì´ë¦„)
      # Streamlitì—ì„œ FastAPIë¥¼ í˜¸ì¶œí•  ë•Œ Docker ë„¤íŠ¸ì›Œí¬ ë‚´ë¶€ ì£¼ì†Œ ì‚¬ìš©
      - FASTAPI_URL=http://fastapi-api:8000 
    depends_on:
      # Streamlitì€ FastAPIê°€ ì¤€ë¹„ë˜ê³  RAG íŒŒì´í”„ë¼ì¸ì´ ì´ˆê¸°í™”ëœ í›„ì— ì‹œì‘
      fastapi-api:
        condition: service_healthy
        
    # ğŸ’¡ [í•µì‹¬ ìˆ˜ì •]: Streamlit ì‹¤í–‰ ëª…ë ¹ì–´ë§Œ ëª…í™•í•˜ê²Œ ë¶„ë¦¬
    command: streamlit run src/streamlit_app.py --server.port 8501 --server.address 0.0.0.0

# Docker ë³¼ë¥¨ ì •ì˜
volumes:
  chroma_data: