# Docker Compose Version: êµ¬í˜• í™˜ê²½ í˜¸í™˜ì„ ìœ„í•´ version ë¼ì¸ ì œê±°

services:
  # --- 1. Vector Database: ChromaDB ---
  chromadb:
    image: chromadb/chroma:0.4.24
    container_name: vector_db
    ports:
      - "8000:8000"
    volumes:
      - chroma-data:/chroma/chroma
    environment:
      # ChromaDB ë°ì´í„° ì˜êµ¬ ì €ì¥ ì„¤ì •
      - IS_PERSISTENT=TRUE
      - PERSIST_DIRECTORY=/chroma/chroma
      - ANONYMIZED_TELEMETRY=FALSE
    networks:
      - rag-network
    restart: unless-stopped
    # Healthcheck ë¸”ë¡ ì—†ìŒ.

  # --- 2. LangChain RAG Application (FastAPI & Streamlit) ---
  rag-app:
    # ğŸš¨ êµ¬í˜• ë¬¸ë²•ìœ¼ë¡œ ë³€ê²½: build: ë‹¤ìŒì— ì»¨í…ìŠ¤íŠ¸ ê²½ë¡œë§Œ í•œ ì¤„ë¡œ ì§€ì •
    build: . 
    
    container_name: rag-application
    
    # ğŸ’¡ í™˜ê²½ ë³€ìˆ˜ ì£¼ì… ì¶”ê°€
    env_file: .env 
    
    # ì™¸ë¶€ í¬íŠ¸: 8501 (Streamlit), 8080 (FastAPI)
    ports:
      - "8501:8501"
      - "8080:8080"
    volumes:
      # ê°œë°œ í¸ì˜ì„±ì„ ìœ„í•´ í˜„ì¬ ë””ë ‰í† ë¦¬ ì „ì²´ë¥¼ ë§ˆìš´íŠ¸
      - .:/app 
      - /app/node_modules # ë…¸ë“œ ëª¨ë“ˆ ì œì™¸ (í•„ìš” ì‹œ)
    environment:
      # ChromaDB ì—°ê²° ì •ë³´ (ì»¨í…Œì´ë„ˆ ì´ë¦„ê³¼ í¬íŠ¸ ì‚¬ìš©)
      - CHROMA_HOST=vector_db
      - CHROMA_PORT=8000
      - PYTHONUNBUFFERED=1
      # ğŸš¨ UPSTAGE_API_KEY ì„¤ì • ì¤„ì€ env_fileë¡œ ëŒ€ì²´ë˜ë¯€ë¡œ ì‚­ì œí•˜ê±°ë‚˜ ì£¼ì„ ì²˜ë¦¬í•´ì•¼ í•¨!
      # - UPSTAGE_API_KEY=${UPSTAGE_API_KEY} 
      
    depends_on:
      chromadb:
        condition: service_started
    networks:
      - rag-network
    restart: unless-stopped
    
    # FastAPIì™€ Streamlitì„ ë™ì‹œì— ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰
    command: sh -c "uvicorn src.main:app --host 0.0.0.0 --port 8080 --reload & streamlit run src/streamlit_app.py --server.port 8501 --server.enableCORS false"

# --- 3. Network Definition (ì„œë¹„ìŠ¤ ê°„ í†µì‹ ) ---
networks:
  rag-network:
    driver: bridge

# --- 4. Volume Definition (ë°ì´í„° ì˜ì†ì„±) ---
volumes:
  chroma-data:
    driver: local