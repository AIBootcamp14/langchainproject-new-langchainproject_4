version: '3.8'

services:
  # --- 1. Vector Database: ChromaDB ---
  chromadb:
    image: chromadb/chroma:0.4.24 # ğŸ’¡ ë²„ì „ ëª…ì‹œ: latest ëŒ€ì‹  íŠ¹ì • ë²„ì „ì„ ì‚¬ìš©í•´ ì•ˆì •ì„± í™•ë³´
    container_name: vector_db # ğŸ’¡ ì»¨í…Œì´ë„ˆ ì´ë¦„ ë‹¨ìˆœí™” ë° env íŒŒì¼ê³¼ì˜ í†µì¼ (CHROMA_HOST=vector_db)
    ports:
      - "8000:8000"
    volumes:
      # ğŸ’¡ Named Volume ì‚¬ìš©: ë°ì´í„° ì˜ì†ì„± ê´€ë¦¬ì— ë” ì í•©
      - chroma-data:/chroma/chroma
    environment:
      - IS_PERSISTENT=TRUE
      - PERSIST_DIRECTORY=/chroma/chroma
      - ANONYMIZED_TELEMETRY=FALSE
    networks:
      - rag-network # ğŸ’¡ ë„¤íŠ¸ì›Œí¬ ì´ë¦„ ë³€ê²½: í”„ë¡œì íŠ¸ ëª…í™•ì„± í™•ë³´
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/heartbeat"]
      interval: 10s # ğŸ’¡ ê°„ê²© ë‹¨ì¶•: ì„œë¹„ìŠ¤ ì¤€ë¹„ ì‹œê°„ì„ ì¤„ì„
      timeout: 5s
      retries: 5

  # --- 2. LangChain RAG Application (FastAPI & Streamlit) ---
  rag-app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rag-application
    # ğŸ’¡ ports ìˆ˜ì •: FastAPIìš© í¬íŠ¸ 8000ê³¼ ì¶©ëŒ í”¼í•˜ê³ , API ì „ìš© í¬íŠ¸ 8080ì„ ëª…ì‹œ
    ports:
      - "8501:8501"  # Streamlit UI
      - "8080:8080"  # FastAPI API (API ì„œë²„ì— ë§ì¶° 5000 ëŒ€ì‹  8080 ì‚¬ìš©)
    volumes:
      - .:/app # ğŸ’¡ í˜„ì¬ ë””ë ‰í† ë¦¬ ì „ì²´ë¥¼ ë§ˆìš´íŠ¸: ì½”ë“œ ë³€ê²½ ì‹œ ì¬ë¹Œë“œ ì—†ì´ ë°”ë¡œ ë°˜ì˜ (ê°œë°œ ìš©ì´ì„±)
      - /app/node_modules # ğŸ’¡ node_modulesê°€ ìˆë‹¤ë©´ ë³¼ë¥¨ ë§ˆìš´íŠ¸ ëŒ€ìƒì—ì„œ ì œì™¸
    environment:
      # ğŸ’¡ ChromaDB í˜¸ìŠ¤íŠ¸ ì´ë¦„ì„ ì»¨í…Œì´ë„ˆ ì´ë¦„ê³¼ ì¼ì¹˜ì‹œì¼œ ëª¨ë“ˆì—ì„œ í™˜ê²½ ë³€ìˆ˜(CHROMA_HOST) ì‚¬ìš© ìš©ì´í•˜ê²Œ í•¨
      - CHROMA_HOST=vector_db
      - CHROMA_PORT=8000
      - PYTHONUNBUFFERED=1
      # ğŸ’¡ SOLAR_API_KEYë¡œ í™˜ê²½ ë³€ìˆ˜ ì´ë¦„ í†µì¼ (llm.pyì—ì„œ ì‚¬ìš©)
      - SOLAR_API_KEY=${SOLAR_API_KEY} 
      # ğŸ’¡ API í‚¤ ë³€ìˆ˜ ì´ë¦„ì„ í”„ë¡œì íŠ¸ ê¸°ì¤€(SOLAR_API_KEY)ìœ¼ë¡œ í†µì¼í•˜ëŠ” ê²ƒì„ ê¶Œì¥
    depends_on:
      chromadb:
        condition: service_healthy
    networks:
      - rag-network
    restart: unless-stopped
    # ğŸ’¡ command ìˆ˜ì •: main.pyë¥¼ uvicornìœ¼ë¡œ ì‹¤í–‰í•˜ë„ë¡ ê¸°ë³¸ ëª…ë ¹ ë³€ê²½ (API ì„œë²„ê°€ ì£¼ ì—­í• )
    command: uvicorn src.main:app --host 0.0.0.0 --port 8080 --reload

# --- 3. Network Definition ---
networks:
  rag-network:
    driver: bridge

# --- 4. Volume Definition (ë°ì´í„° ì˜ì†ì„±) ---
volumes:
  chroma-data:
    driver: local # ChromaDB ë°ì´í„° ì €ì¥ì†Œ (./data/chroma_docker í´ë”ì— ì €ì¥ë¨)